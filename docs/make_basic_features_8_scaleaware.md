単一 DEM から 8 つの地形特徴量を一括生成するスクリプト
（マルチスケール＋SAGA 開度対応＋外縁マスク統一＋勾配/曲率スムージング＋R↔R_open スケール整合）

ファイル名:
  make_basic_features_8_scaleaware.py

想定用途:
  - 1 枚の DEM から、地形分類用の「基本 8 特徴量」を一括生成する。
  - 比高・標準偏差・開度については、ユーザが指定したスケール R[m]／R_open[m] に応じて
    「どの空間スケールの地形（谷・尾根・盆地など）を見たいか」を制御できる。
  - 勾配・斜面方位・ラプラシアン・平均曲率は、Horn(1981) 型の 3×3 オペレータによる
    ピクセルレベルの指標としつつ、任意スケールの平滑化 DEM から計算した派生版も出力できる。
  - R と R_open のスケール整合（面積等価 / 内接円 / 外接円）を選択可能。

入力:
  - DEM (GeoTIFF, 北が上・等方ピクセル前提, 解像度 px [m])

    * スクリプト内では、水平解像度を px[m] として扱う。
    * 対話モードで r（比高/偏差の半径）や R_open（開度の最大距離）を
      「m 指定」または「ピクセル数指定」で入力できるが、
      内部ではすべて物理スケール [m] に変換して扱う。

出力:
  - out_dir/
  - out_dir/
      {stem}_relief_r{R_eff}m.tif
      {stem}_stddev_r{R_eff}m.tif
      {stem}_slope_deg.tif
      {stem}_aspect_deg.tif
      {stem}_laplacian.tif
      {stem}_mean_curvature.tif
      {stem}_openness_pos_r{R_open}m_nd{n_dirs}dir.tif
      {stem}_openness_neg_r{R_open}m_nd{n_dirs}dir.tif

    ＋（オプション: 勾配・曲率のスムージング版）
      {stem}_slope_deg_r{R_s}m_box.tif
      {stem}_aspect_deg_r{R_s}m_box.tif
      {stem}_laplacian_r{R_s}m_box.tif
      {stem}_mean_curvature_r{R_s}m_box.tif

      {stem}_slope_deg_r{R_s}m_gauss.tif
      {stem}_aspect_deg_r{R_s}m_gauss.tif
      {stem}_laplacian_r{R_s}m_gauss.tif
      {stem}_mean_curvature_r{R_s}m_gauss.tif

  - R, R_open, R_s は「物理スケール [m]」としてファイル名に反映される。
    ただし比高 / 標準偏差については、ファイル名の rXXm は
      「ユーザ指定 R[m] から決まる窓の有効半径 R_eff[m]」
    を用いる（R_eff≒((k-1)/2)*px）。
----------------------------------------------------------------------
■ このスクリプトで出力される 8 指標
----------------------------------------------------------------------

  1) 局所比高 (relief_r{R_eff}m)
  2) 局所標準偏差 (stddev_r{R_eff}m)
  3) 勾配角 (slope_deg)
  4) 斜面方位 (aspect_deg)
  5) ラプラシアン (laplacian)
  6) 平均曲率 (mean_curvature)
  7) 正開度 (openness_pos_r{R_open}m_nd{n_dirs}dir)
  8) 負開度 (openness_neg_r{R_open}m_nd{n_dirs}dir)

  - 1), 2), 7), 8) はユーザ指定の空間スケール R[m], R_open[m] に依存。
  - 3)〜6) は Horn(1981) 型の 3×3 オペレータ（ピクセルレベル）で計算する
    「基本版」に加え、任意スケールで平滑化した DEM から計算した派生版
    （R_smooth = R_s[m]）もオプションで出力可能。

----------------------------------------------------------------------
■ ピクセル解像度と窓サイズ k の関係
----------------------------------------------------------------------

DEM の水平解像度を px[m] とし、比高・標準偏差の半径 R[m] を指定したとき、
ローカル統計用の窓サイズ k[ピクセル] を

    k = round(R / px)
    k が偶数なら k ← k + 1   （中心セルを持つよう必ず奇数にする）

とする。これにより、中心セル (i, j) を中心とする k×k の正方形窓 W_k(i, j) を用いる。
物理的な「有効半径」は

    R_eff ≈ ((k - 1) / 2) * px   [m]

となる。

※ 比高 / 標準偏差は、この k×k 窓内の「全ての有効セル」を使う。
   リング状に内側を飛ばす「ドーナツ窓」は用いない。

----------------------------------------------------------------------
■ 局所比高 / 局所標準偏差 の定義
----------------------------------------------------------------------

1) 局所比高 (relief_r{R_eff}m)
   - イメージ: k×k 窓に含まれる標高値の「最大値 − 最小値」
   - 近傍: k×k 窓（8近傍を含む窓内全ピクセル）
   - 定義:
       R(i, j; k) = max_{(u, v) ∈ W_k(i, j)} z(u, v)
                  - min_{(u, v) ∈ W_k(i, j)} z(u, v)

2) 局所標準偏差 (stddev_r{R_eff}m)
   - イメージ: k×k 窓に含まれる標高値の「ばらつき」
   - 近傍: k×k 窓（8近傍を含む窓内全ピクセル）
   - 定義:
       μ(i, j) = (1 / N) Σ_{(u, v) ∈ W_k(i, j)} z(u, v)
       σ(i, j) = sqrt( (1 / N) Σ_{(u, v) ∈ W_k(i, j)} z(u, v)^2 - μ(i, j)^2 )

     （N は窓内の有効セル数）

----------------------------------------------------------------------
■ 勾配角 / 斜面方位 / ラプラシアン / 平均曲率 の定義
  （R や R_open に依存しない「ピクセルレベル」の指標）
----------------------------------------------------------------------

3) 勾配角 (slope_deg)
   - イメージ: 3×3 近傍全体を 1 枚の斜平面とみなしたときの「傾きの大きさ」
   - 近傍: 3×3 の 8近傍
   - Horn (1981) の 3×3 オペレータで gx, gy を求める:
       gx ≈ (1 / (8 px)) * [[-1, 0, 1],
                            [-2, 0, 2],
                            [-1, 0, 1]] * z
       gy ≈ (1 / (8 px)) * [[ 1,  2,  1],
                            [ 0,  0,  0],
                            [-1, -2, -1]] * z
   - 勾配角:
       slope(i, j) = atan( sqrt(gx^2 + gy^2) )  [rad] を [deg] に変換

4) 斜面方位 (aspect_deg)
   - イメージ: 3×3 近傍全体を 1 枚の斜平面とみなしたときの「傾きの向き」
   - 近傍: 勾配と同じ 3×3 の 8近傍
   - 定義（0°=東, 90°=北, 反時計回り）:
       aspect(i, j) = atan2(gy, gx)  [rad] を 0〜360° に正規化

5) ラプラシアン (laplacian)
   - イメージ: 中心セルが、周囲セル（3×3 窓, 中心セル除く）の平均から
                どれだけ「浮き・沈み」しているか
   - 近傍: 3×3 の 8近傍
   - 8近傍ラプラシアンカーネル:
       ∇²z(i, j) ≈ (1 / px^2) * (
           z_{i-1,j-1} + z_{i,  j-1} + z_{i+1,j-1} +
           z_{i-1,j  } - 8 z_{i,  j  } + z_{i+1,j  } +
           z_{i-1,j+1} + z_{i,  j+1} + z_{i+1,j+1}
       )

6) 平均曲率 (mean_curvature)
   - イメージ: 中心セルまわりの地表がどれだけ丸く「凸/凹」しているか
                （谷底では +、尾根では −、一直線の斜面では 0 に近づく）
   - 近傍: 主に 3×3 の 8近傍と、その延長方向の有限差分
   - R や R_open には依存せず、DEM の解像度 px[m] のみでスケールが決まる。
   - 実装では np.gradient を用いて、連続場 z(x, y) の平均曲率 H を
     有限差分で近似している：

       zx  = ∂z/∂x,  zy  = ∂z/∂y
       zxx = ∂²z/∂x², zyy = ∂²z/∂y², zxy = ∂²z/∂x∂y

       H = [ (1 + zy²) zxx - 2 zx zy zxy + (1 + zx²) zyy ]
           / [ 2 (1 + zx² + zy²)^(3/2) ]

     ここで zx, zy, zxx, zyy, zxy は、上下左右およびその周辺セルの
     差分から求めており、「指定半径 R 内のリング」だけを使うような
     ドーナツ型の窓は用いていない。

  - スムージング版の勾配・曲率は、
      ・DEM を移動平均（ボックスフィルタ） / ガウシアンフィルタで平滑化
      → その平滑化 DEM に対して上記 3)〜6) と同じ式を適用
    して求める。
    （平滑化スケール R_s[m] も対話的に指定可能）

----------------------------------------------------------------------
■ 開度（正開度 / 負開度）と R_open の定義
  （R_open[m] に依存する「方向レイ型」の指標）
----------------------------------------------------------------------

開度（Topographic Openness）は、中心セル (i, j) に対して

   「中心から各方向へ伸ばしたレイ上の標高を、最大距離 R_open[m] の範囲で
     見上げ角／見下ろし角として評価し、それを全方向で平均した角度指標」

である。

DEM の水平分解能を px[m] とし、開度の最大探索半径を R_open[m] とすると、
レイの最大ステップ数 r_max は

    r_max = floor(R_open / px)

となる。

----------------------------------------------------------------------
● 方向分割とレイ（近傍の取り方）
----------------------------------------------------------------------

全周を n_dirs 本の方向に等分し、方向 d（d = 1…n_dirs）の方位角を θ_d とする。
各方向 d について、中心セル (i, j) から最大 r_max ピクセル先まで

    (x_d(r), y_d(r)) = (i + r cosθ_d,  j + r sinθ_d)   （r = 1…r_max）

に従ってレイを伸ばす。水平距離は

    L(r) = r * px   [m]

標高値 z_d(r) は（SAGA ta_lighting の場合は線分追跡、
Python 内蔵実装ではバイリニア補間）で取得する。

----------------------------------------------------------------------
● 仰角／俯角の定義
----------------------------------------------------------------------

中心セルの標高を z0 = z(i, j) とすると、方向 d, ステップ r における

    仰角（上向き）:  α_d(r) = arctan( (z_d(r) - z0) / L(r) )   [deg]
    俯角（下向き）:  β_d(r) = arctan( (z0 - z_d(r)) / L(r) )   [deg]

とする。方向 d における最大仰角／最大俯角を

    α_d^max = max_r α_d(r)
    β_d^max = max_r β_d(r)

と定義する。

----------------------------------------------------------------------
● 方向別の正開度／負開度
----------------------------------------------------------------------

方向 d における正開度・負開度は

    POS_d = 90° - α_d^max
    NEG_d = 90° - β_d^max

と定義する。

  - 正開度 POS_d が大きい   → 上方向に空が大きく見える（尾根・台地側）
  - 正開度 POS_d が小さい   → 周囲を崖で囲まれた谷底・凹地

  - 負開度 NEG_d が大きい   → 周囲に向かって落ち込む凸地形（尾根・崖頭）
  - 負開度 NEG_d が小さい   → 周囲から見下ろされる凹地形（谷・盆地）

----------------------------------------------------------------------
● 全方向平均としての開度
----------------------------------------------------------------------

中心セル (i, j) の正開度／負開度は

    openness_pos(i, j)
        = (1 / n_dirs) Σ_d POS_d
        = (1 / n_dirs) Σ_d (90° - α_d^max)

    openness_neg(i, j)
        = (1 / n_dirs) Σ_d NEG_d
        = (1 / n_dirs) Σ_d (90° - β_d^max)

とする。本スクリプトでは、この openness_pos / openness_neg を
GeoTIFF として出力する。

----------------------------------------------------------------------
■ R_open[m] の役割（R と同様「空間スケール」の指定）
----------------------------------------------------------------------

R_open はレイの最大探索距離であり、比高・標準偏差の R[m] と同じく

    「どの空間スケールの谷／尾根／盆地を見たいか」

を決めるパラメータである。

  - R_open が大きい → 広域の谷・尾根・盆地の“骨格”が強調
  - R_open が小さい → 小崖・小凹凸・微地形が強調

本スクリプトでは

    R（比高・偏差の半径）, R_open（開度の最大距離）, R_s（平滑化スケール）

のすべてを「物理スケール [m]」として扱う。

----------------------------------------------------------------------
■ R と R_open の“空間スケール整合”の幾何学的対応
----------------------------------------------------------------------

比高・標準偏差は k×k の正方形窓 W_k(i, j) を用い、その物理的な有効半径を

    R_eff = ((k - 1) / 2) * px   [m]

とする。

開度（円形レイ）でこの R_eff と同等のスケールを扱いたい場合、
本スクリプトでは以下 3 方式から R_open の決め方を選択できる。

  1) 面積等価円（デフォルト）
       - 正方形窓（辺長 ≒ 2 R_eff）の面積 A_sq と、同じ面積をもつ円の半径 R_eq を
         等しくする。
           A_sq ≒ (2 R_eff)^2
           π R_eq^2 = A_sq
           → R_eq = (2/√π) R_eff ≒ 1.1284 R_eff

       - スクリプト上では、
           R_open ≒ (2/√π) R_eff
         として自動設定する。

  2) 内接円半径（最小スケール）
       - 正方形窓の内接円半径をとる。
           R_open = R_eff

       - 比高・標準偏差の「実効半径 R_eff」と真っ直ぐ対応するため
         最も保守的な（やや小さめの）スケール整合となる。

  3) 外接円半径（最大スケール）
       - 正方形窓の外接円半径をとる。
           R_open = R_eff * sqrt(2)

       - 正方形の対角線方向まで含めて完全にカバーするスケール。
         面積等価円よりもやや大きなスケールを見に行く設定となる。

対話プロンプトでは

  - 「R_open を手動指定する」
  - 「R_eff と整合する R_open を自動算出する（面積等価 / 内接円 / 外接円）」

を選択できる。

----------------------------------------------------------------------
■ 外縁マスクの扱い
----------------------------------------------------------------------

  - 比高・標準偏差:
      必要な k×k 窓が完全に取れない外縁は NODATA（共通外縁マスク）とする。

  - 開度:
      レイが指定 R_open[m] まで到達できないセル（DEM 外縁付近）は、
      正しい角度評価ができないため NODATA とする。
      R_open が大きいほど有効領域は内側に狭くなる。

  - 勾配・斜面方位・ラプラシアン・平均曲率（基本版）:
      3×3 オペレータに応じて、1 ピクセル幅の外縁を NODATA とする。

  - スムージング版の勾配・曲率:
      平滑化カーネルの有効半径 R_s[m] と 3×3 オペレータを合成した
      近似的な有効窓サイズに応じて外縁をマスクする。

このようにして、全ての出力レイヤで「外縁における NODATA の扱い」を
できるだけ整合的にそろえる。


----------------------------------------------------------------------
■ 解像度と窓サイズ (k×k) の関係
----------------------------------------------------------------------

本スクリプトでは、「各セル中心に対して、周囲の地形を要約する」ことを前提としているため、  
**窓サイズは必ず奇数 (3×3, 5×5, 9×9, …) を採用** しています。

### なぜ奇数窓 (3×3, 5×5, …) を使うのか？

#### 1次元のイメージ

セル中心を ● で表すとします。

奇数窓（3セル）の場合：

    位置:   0   1   2   3
           ●   ●   ●   ●
               ↑
           [  ●  ●  ●  ]
              3セル窓
       → セル1が「中心」で、その左右に1セルずつ

偶数窓（4セル）の場合：

    位置:   0   1   2   3
           ●   ●   ●   ●
              ↑   ↑
           [  ●  ●  ●  ● ]
             4セル窓の「中心」は 1.5 の位置
       → セル中心ではなく、セルとセルの間に中心が来てしまう

偶数窓では「どのセルを中心として扱うか」が曖昧になるため、  
**「セル中心ごとに特徴量を定義する」という DEM の考え方とズレてしまいます。**

#### 2次元グリッドのイメージ（3×3 vs 4×4）

3×3 窓（奇数）の場合：

```text
●  ●  ●
● [●] ●   ← 真ん中のセルが中心
●  ●  ●
